<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Fosmjo&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Fosmjo&#39;s Blog">
<meta property="og:url" content="https://fosmjo.github.io/index.html">
<meta property="og:site_name" content="Fosmjo&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="fosmjo">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Fosmjo's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Fosmjo&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://fosmjo.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-asynq" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/02/18/asynq/" class="article-date">
  <time class="dt-published" datetime="2023-02-18T13:17:28.000Z" itemprop="datePublished">2023-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/02/18/asynq/">Asynq 原理分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><a target="_blank" rel="noopener" href="https://github.com/hibiken/asynq">Asynq</a> 是一款用 go 语言编写的基于 redis 的分布式任务队列，支持即时任务和定时任务。</p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><p>Asynq 使用 redis 的 <code>List</code> 和 <code>Sorted Set</code> 作为任务队列，队列中只存储任务ID，任务内容使用 redis 的 <code>Hash</code> 存储。对应的数据模型如下：</p>
<table>
<thead>
<tr>
<th>数据</th>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td><code>List</code> 类型队列</td>
<td>队列名称</td>
<td>成员是任务ID</td>
</tr>
<tr>
<td><code>Sorted Set</code> 类型队列</td>
<td>队列名称</td>
<td>成员是任务ID，分数是关联的时间戳</td>
</tr>
<tr>
<td>任务内容</td>
<td>任务ID</td>
<td><code>&#123;&quot;msg&quot;: &quot;...&quot;, &quot;state&quot;: &quot;...&quot;&#125;</code></td>
</tr>
</tbody></table>
<p>任务状态值域： pending，active，completed，retry，archived，scheduled 。</p>
<h2 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2><p>Asynq 运行时涉及到以下队列：</p>
<table>
<thead>
<tr>
<th>队列类型</th>
<th>使用的redis数据类型</th>
<th>队列元素内容</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>pending</td>
<td>List</td>
<td>task-id</td>
<td>存储准备执行的任务</td>
</tr>
<tr>
<td>active</td>
<td>List</td>
<td>task-id</td>
<td>存储正在执行的任务</td>
</tr>
<tr>
<td>lease</td>
<td>Sorted Set</td>
<td>task-id, lease-expiration-time</td>
<td>存储正在执行的任务的lease</td>
</tr>
<tr>
<td>completed</td>
<td>Sorted Set</td>
<td>task-id, task-exipration-time</td>
<td>存储成功的且设置了保留期的任务</td>
</tr>
<tr>
<td>retry</td>
<td>Sorted Set</td>
<td>task-id, retry-time</td>
<td>存储一段时间后要重试的任务</td>
</tr>
<tr>
<td>archived</td>
<td>Sorted Set</td>
<td>task-id, archive-time</td>
<td>存储归档任务</td>
</tr>
<tr>
<td>scheduled</td>
<td>Sorted Set</td>
<td>task-id, process-time</td>
<td>存储定时任务</td>
</tr>
</tbody></table>
<p>用户通过 asynq 客户端将任务发布到 asynq 服务器，发布任务时会将即时任务写入 pending 队列，定时任务写入 scheduled 队列。Asynq 服务器端负责执行任务，涉及到 processor，heartbeater，recorver，forwarder，janitor 等多个模块。各模块功能如下：</p>
<ul>
<li>processor 模块从 pending 队列中拉取任务，将任务移到 active 队列，为了避免任务执行过程中服务器宕机导致任务丢失，会给每个任务设定一个 lease，并将任务ID和 lease 到期时间写入 lease 列中。每个任务通过单独的 goroutine worker 执行，任务执行有3种情况：<ul>
<li>执行成功：将任务从 active 和 lease 队列移除，如果任务设置了保留时间，就将任务写入 completed 队列</li>
<li>执行失败：将任务从 active 和 lease 队列移除，检查任务是否超过指定重试次数，若超过就将任务写入 archived 队列，否则写入 retry 队列</li>
<li>在 lease 有效期内，worker 没有反馈执行结果：留给 recorver 模块处理</li>
</ul>
</li>
<li>heartbeater 模块定期将 worker 执行信息写入 redis，并延长正在执行的任务的 lease，确保正在执行中的任务不受 lease 到期的影响</li>
<li>recorver 模块定期检查 lease 队列，将到期的任务移出，检查任务是否超过指定重试次数，若超过就将任务写入 archived 队列，否则写入 retry 队列</li>
<li>forwarder 模块定期检查 scheduled 和 retry 队列，将到期的任务移到 pending 队列中等待执行</li>
<li>janitor 模块定期检查 completed 队列，将超过保留期的任务删除</li>
</ul>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li>Redis 的 <code>List</code> 可用作 FIFO 队列</li>
<li>Redis 的 <code>Sorted Set</code> 可用作优先队列</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://fosmjo.github.io/2023/02/18/asynq/" data-id="clearyniq00009eoq8cqd2ut4" data-title="Asynq 原理分析" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asynq/" rel="tag">asynq</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/task-queue/" rel="tag">task-queue</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-genesis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/02/12/genesis/" class="article-date">
  <time class="dt-published" datetime="2023-02-12T07:43:08.000Z" itemprop="datePublished">2023-02-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/02/12/genesis/">Genesis</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to Fosmjo’s blog.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://fosmjo.github.io/2023/02/12/genesis/" data-id="clearyniw00019eoq8cwu4utg" data-title="Genesis" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/asynq/" rel="tag">asynq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/task-queue/" rel="tag">task-queue</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/asynq/" style="font-size: 10px;">asynq</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/task-queue/" style="font-size: 10px;">task-queue</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/02/18/asynq/">Asynq 原理分析</a>
          </li>
        
          <li>
            <a href="/2023/02/12/genesis/">Genesis</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 fosmjo<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>